#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")")" && pwd)"
CONFIG_FILE="$SCRIPT_DIR/.maple_config"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

usage() {
    echo -e "${BOLD}maple${NC} - Route traffic through your remote proxy server"
    echo ""
    echo -e "${BOLD}Usage:${NC}"
    echo "  maple global          Enable global mode (all traffic via server)"
    echo "  maple split           Enable split mode (only domains.txt via server)"
    echo "  maple off             Disable all proxying (restore direct connection)"
    echo "  maple add <domain>    Add domain to proxy list"
    echo "  maple remove <domain> Remove domain from proxy list"
    echo "  maple list            Show proxied domains"
    echo "  maple status          Show current mode and connectivity"
    echo "  maple test            Test proxy connectivity"
    echo "  maple ping            Measure latency to server"
    echo "  maple speed           Measure download speed via proxy"
    echo "  maple setup           Initial setup (configure server IP)"
    echo "  maple help            Show this help"
    echo ""
    echo -e "${BOLD}Examples:${NC}"
    echo "  maple global          # Before an interview (Zoom/Teams)"
    echo "  maple split           # After interview, back to split routing"
    echo "  maple off             # Disable all proxying"
    echo "  maple add netflix.com # Add a domain to split routing"
    echo "  maple ping            # Check latency to server"
    echo "  maple speed           # Measure connection speed"
}

check_config() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo -e "${RED}ERROR: Not configured. Run 'maple setup' first.${NC}"
        exit 1
    fi
    source "$CONFIG_FILE"
}

# Detect the active network service for proxy configuration
get_active_service() {
    local service
    while IFS= read -r service; do
        [[ "$service" == "*"* ]] && continue
        [[ -z "$service" ]] && continue
        if networksetup -getinfo "$service" 2>/dev/null | grep -q "IP address: [0-9]"; then
            echo "$service"
            return
        fi
    done < <(networksetup -listallnetworkservices)
}

cmd_global() {
    check_config
    bash "$SCRIPT_DIR/global_on.sh"
}

cmd_split() {
    check_config

    # Disable exit node
    echo "Switching to split mode..."
    sudo tailscale set --exit-node=

    # Ensure PAC auto-proxy is enabled
    local active_service
    active_service=$(get_active_service)
    if [[ -n "${active_service:-}" ]]; then
        networksetup -setautoproxyurl "$active_service" "file://$SCRIPT_DIR/proxy.pac"
        networksetup -setautoproxystate "$active_service" on
        echo -e "${GREEN}Split mode ON.${NC} Only domains.txt traffic goes through server."
    else
        echo -e "${YELLOW}WARNING: Could not detect active network service.${NC}"
        echo "Set auto-proxy URL manually: file://$SCRIPT_DIR/proxy.pac"
    fi
}

cmd_off() {
    # Disable exit node
    echo "Disabling all proxying..."
    sudo tailscale set --exit-node=

    # Disable PAC auto-proxy
    local active_service
    active_service=$(get_active_service)
    if [[ -n "${active_service:-}" ]]; then
        networksetup -setautoproxystate "$active_service" off
        echo -e "${GREEN}Proxy OFF.${NC} All traffic is now direct."
    else
        echo -e "${YELLOW}WARNING: Could not detect active network service.${NC}"
        echo "Disable auto-proxy manually in System Settings > Network > Proxies."
    fi
}

cmd_add() {
    local domain="$1"
    local domains_file="$SCRIPT_DIR/domains.txt"

    # Normalize: remove protocol prefix if present
    domain=$(echo "$domain" | sed 's|https\?://||' | sed 's|/.*||')

    # Check if already exists
    if grep -qx "$domain" "$domains_file" 2>/dev/null; then
        echo -e "${YELLOW}Domain '$domain' already in proxy list.${NC}"
        return
    fi

    echo "$domain" >> "$domains_file"
    echo -e "${GREEN}Added '$domain' to proxy list.${NC}"

    # Regenerate PAC
    check_config
    bash "$SCRIPT_DIR/generate_pac.sh"
}

cmd_remove() {
    local domain="$1"
    local domains_file="$SCRIPT_DIR/domains.txt"

    # Normalize
    domain=$(echo "$domain" | sed 's|https\?://||' | sed 's|/.*||')

    if ! grep -qx "$domain" "$domains_file" 2>/dev/null; then
        echo -e "${YELLOW}Domain '$domain' not found in proxy list.${NC}"
        return
    fi

    # Remove the domain line (escape dots for sed)
    local escaped_domain
    escaped_domain=$(echo "$domain" | sed 's/\./\\./g')
    sed -i '' "/^${escaped_domain}$/d" "$domains_file"
    echo -e "${GREEN}Removed '$domain' from proxy list.${NC}"

    # Regenerate PAC
    check_config
    bash "$SCRIPT_DIR/generate_pac.sh"
}

cmd_list() {
    local domains_file="$SCRIPT_DIR/domains.txt"
    echo -e "${BLUE}=== Proxied Domains ===${NC}"
    echo ""

    local current_section=""
    while IFS= read -r line; do
        if [[ "$line" =~ ^#\ ===\ (.+)\ ===$ ]]; then
            current_section="${BASH_REMATCH[1]}"
            echo -e "${BOLD}${current_section}${NC}"
        elif [[ -n "$line" && ! "$line" =~ ^# ]]; then
            echo "  $line"
        fi
    done < "$domains_file"

    echo ""
    local count
    count=$(grep -v '^#' "$domains_file" | grep -v '^$' | wc -l | xargs)
    echo -e "Total: ${GREEN}${count}${NC} domains"
}

cmd_status() {
    check_config
    echo -e "${BLUE}=== Maple Status ===${NC}"
    echo ""

    # Determine mode: GLOBAL / SPLIT / OFF
    local mode="OFF"
    local mode_color="$RED"
    local mode_desc="all traffic direct"

    if command -v tailscale &>/dev/null; then
        local ts_status
        ts_status=$(tailscale status 2>/dev/null || echo "")

        if echo "$ts_status" | grep -q "exit node"; then
            mode="GLOBAL"
            mode_color="$GREEN"
            mode_desc="all traffic via server"
        else
            # Check if PAC auto-proxy is enabled
            local active_service
            active_service=$(get_active_service)
            local pac_enabled="off"
            if [[ -n "${active_service:-}" ]]; then
                pac_enabled=$(networksetup -getautoproxyurl "$active_service" 2>/dev/null | grep -i 'enabled' | awk '{print $2}' || echo "off")
            fi
            if [[ "$pac_enabled" == "yes" || "$pac_enabled" == "Yes" ]]; then
                mode="SPLIT"
                mode_color="$YELLOW"
                mode_desc="domains.txt traffic via server"
            fi
        fi

        echo -e "  Mode:        ${mode_color}${mode}${NC} (${mode_desc})"
        echo -e "  Tailscale:   ${GREEN}Connected${NC}"
    else
        echo -e "  Mode:        ${RED}OFF${NC} (Tailscale not installed)"
        echo -e "  Tailscale:   ${RED}Not installed${NC}"
    fi

    echo -e "  Server IP:   ${MAPLE_SERVER_IP}"
    echo -e "  Proxy Port:  ${MAPLE_PROXY_PORT:-3128}"

    # Check proxy connectivity
    echo ""
    echo -n "  Proxy:       "
    if curl -s --connect-timeout 10 --max-time 15 --proxy "http://${MAPLE_SERVER_IP}:${MAPLE_PROXY_PORT:-3128}" "http://httpbin.org/ip" 2>&1 | grep -q 'origin'; then
        echo -e "${GREEN}Connected${NC}"
    else
        echo -e "${RED}Unreachable${NC}"
    fi

    # Latency (quick single ping)
    echo -n "  Latency:     "
    local ping_result
    ping_result=$(ping -c 1 -W 3 "$MAPLE_SERVER_IP" 2>/dev/null || true)
    local avg_ms
    avg_ms=$(echo "$ping_result" | grep -oE '[0-9]+\.[0-9]+/[0-9]+\.[0-9]+/[0-9]+\.[0-9]+/[0-9]+\.[0-9]+' | cut -d'/' -f2)
    if [[ -n "${avg_ms:-}" ]]; then
        local ms_int="${avg_ms%%.*}"
        ms_int="${ms_int:-0}"
        if [[ "$ms_int" -lt 100 ]]; then
            echo -e "${GREEN}${avg_ms} ms${NC}"
        elif [[ "$ms_int" -lt 250 ]]; then
            echo -e "${YELLOW}${avg_ms} ms${NC}"
        else
            echo -e "${RED}${avg_ms} ms${NC}"
        fi
    else
        echo -e "${RED}Unreachable${NC}"
    fi

    # Domain count
    local count
    count=$(grep -v '^#' "$SCRIPT_DIR/domains.txt" | grep -v '^$' | wc -l | xargs)
    echo -e "  Domains:     ${count} configured"
}

cmd_test() {
    check_config
    echo -e "${BLUE}=== Connectivity Test ===${NC}"
    echo ""

    # Test Tailscale connection
    echo -n "  Tailscale to server:  "
    if ping -c 1 -W 3 "$MAPLE_SERVER_IP" > /dev/null 2>&1; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${RED}FAIL${NC} - Check Tailscale connection"
    fi

    # Test proxy port
    echo -n "  Squid proxy (3128):   "
    if nc -z -w 3 "$MAPLE_SERVER_IP" "${MAPLE_PROXY_PORT:-3128}" 2>/dev/null; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${RED}FAIL${NC} - Is Squid running on the server?"
    fi

    # Test HTTP through proxy (verify response content, not just HTTP status)
    echo -n "  HTTP via proxy:       "
    local http_result
    http_result=$(curl -s --connect-timeout 10 --max-time 15 --proxy "http://${MAPLE_SERVER_IP}:${MAPLE_PROXY_PORT:-3128}" "http://httpbin.org/ip" 2>&1 || true)
    if echo "$http_result" | grep -q 'origin'; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${RED}FAIL${NC}"
    fi

    # Test HTTPS through proxy (CONNECT tunneling)
    echo -n "  HTTPS via proxy:      "
    local https_result
    https_result=$(curl -s --connect-timeout 15 --max-time 30 --proxy "http://${MAPLE_SERVER_IP}:${MAPLE_PROXY_PORT:-3128}" "https://httpbin.org/ip" 2>&1 || true)
    if echo "$https_result" | grep -q 'origin'; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${RED}FAIL${NC}"
        # Show error detail for debugging
        local curl_err
        curl_err=$(curl -v --connect-timeout 15 --max-time 30 --proxy "http://${MAPLE_SERVER_IP}:${MAPLE_PROXY_PORT:-3128}" "https://httpbin.org/ip" 2>&1 | head -20 || true)
        echo -e "  ${YELLOW}Debug info:${NC}"
        echo "$curl_err" | grep -iE 'error|refused|denied|timeout|connect|HTTP/' | head -5 | while IFS= read -r line; do
            echo "    $line"
        done || true
    fi

    # Show proxy IP
    echo ""
    echo -n "  Your proxy exit IP:   "
    local ip
    ip=$(curl -s --connect-timeout 10 --max-time 20 --proxy "http://${MAPLE_SERVER_IP}:${MAPLE_PROXY_PORT:-3128}" "http://ipinfo.io/ip" 2>&1 || echo "unknown")
    if [[ "$ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo -e "${GREEN}${ip}${NC} (server's public IP)"
    else
        echo -e "${RED}Could not determine${NC}"
    fi
}

cmd_ping() {
    check_config
    echo -e "${BLUE}=== Latency Test ===${NC}"
    echo ""

    # Tailscale ping (measures DERP relay vs direct connection)
    echo -e "${BOLD}Tailscale Ping:${NC}"
    if command -v tailscale &>/dev/null; then
        tailscale ping --c 3 "$MAPLE_SERVER_IP" 2>/dev/null || echo -e "  ${RED}Could not reach server via Tailscale${NC}"
    else
        echo -e "  ${RED}Tailscale not installed${NC}"
    fi

    # ICMP ping
    echo ""
    echo -e "${BOLD}ICMP Ping (5 packets):${NC}"
    local ping_output
    ping_output=$(ping -c 5 -t 10 "$MAPLE_SERVER_IP" 2>&1 || true)

    # Show individual pings (|| true prevents pipefail exit when grep has no matches)
    echo "$ping_output" | grep -E 'bytes from|icmp_seq' | while IFS= read -r line; do
        echo "  $line"
    done || true

    # Show summary
    echo ""
    local stats_line
    stats_line=$(echo "$ping_output" | grep 'packet loss' || true)
    local rtt_line
    rtt_line=$(echo "$ping_output" | grep 'avg' || true)

    if [[ -n "${stats_line:-}" ]]; then
        echo -e "  ${BOLD}Stats:${NC} $stats_line"
    fi
    if [[ -n "${rtt_line:-}" ]]; then
        echo -e "  ${BOLD}RTT:${NC}   $rtt_line"
    fi

    if echo "${stats_line:-}" | grep -q '100.0% packet loss' 2>/dev/null; then
        echo -e "\n  ${RED}Server is unreachable. Check Tailscale connection.${NC}"
    fi
}

# Helper: run a single download speed test and print result
_speed_test() {
    local label="$1"
    local url="$2"
    local proxy_arg="${3:-}"
    local timeout="${4:-30}"

    echo -n "  $label"
    local curl_args=(curl -s --connect-timeout 15 --max-time "$timeout" -o /dev/null -w '%{speed_download} %{time_total}')
    [[ -n "$proxy_arg" ]] && curl_args+=(--proxy "$proxy_arg")
    curl_args+=("$url")

    local result
    result=$("${curl_args[@]}" 2>/dev/null || echo "0 0")
    local bps time_s
    bps=$(echo "$result" | awk '{print $1}')
    time_s=$(echo "$result" | awk '{print $2}')

    if [[ -n "${bps:-}" ]] && [[ "$bps" != "0" ]] && [[ "$bps" != "0.000" ]]; then
        local mbps
        mbps=$(echo "$bps" | awk '{printf "%.2f", $1 * 8 / 1000000}')
        echo -e "${GREEN}${mbps} Mbps${NC} (${time_s}s)"
    else
        echo -e "${RED}Failed${NC}"
    fi
}

cmd_speed() {
    check_config
    echo -e "${BLUE}=== Speed Test ===${NC}"
    echo ""

    local proxy="http://${MAPLE_SERVER_IP}:${MAPLE_PROXY_PORT:-3128}"

    # Use HTTP endpoints to avoid HTTPS tunneling issues
    echo -e "${BOLD}Download Speed (via proxy):${NC}"
    echo ""
    _speed_test "HTTP  1 MB:   " "http://ipv4.download.thinkbroadband.com/1MB.zip" "$proxy" 30
    _speed_test "HTTP 10 MB:   " "http://ipv4.download.thinkbroadband.com/10MB.zip" "$proxy" 60
    _speed_test "HTTPS 1 MB:   " "https://speed.cloudflare.com/__down?bytes=1000000" "$proxy" 30

    echo ""
    echo -e "${BOLD}Direct Download (no proxy):${NC}"
    echo ""
    _speed_test "HTTP  1 MB:   " "http://ipv4.download.thinkbroadband.com/1MB.zip" "" 30
}

cmd_setup() {
    bash "$SCRIPT_DIR/setup.sh"
}

# Main
case "${1:-help}" in
    global)  cmd_global ;;
    split)   cmd_split ;;
    off)     cmd_off ;;
    add)
        [[ -z "${2:-}" ]] && { echo -e "${RED}Usage: maple add <domain>${NC}"; exit 1; }
        cmd_add "$2"
        ;;
    remove|rm)
        [[ -z "${2:-}" ]] && { echo -e "${RED}Usage: maple remove <domain>${NC}"; exit 1; }
        cmd_remove "$2"
        ;;
    list|ls) cmd_list ;;
    status)  cmd_status ;;
    test)    cmd_test ;;
    ping)    cmd_ping ;;
    speed)   cmd_speed ;;
    setup)   cmd_setup ;;
    help|-h|--help) usage ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo ""
        usage
        exit 1
        ;;
esac
